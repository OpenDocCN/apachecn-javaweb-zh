# 微服务基础

虽然单片体系结构有其自身的优点，但当应用程序变得越来越大以支持各种类型的业务逻辑时，开发人员和部署工程师会遇到困难。即使后端只有一个 bug 修复，也会迫使开发人员在服务器上重新部署整个应用程序，从而导致不必要的维护。另一方面，微服务提供了一个选项，可以将业务逻辑分离为服务。因此，可以将应用程序推送到服务器而不中断流程，终端用户尤其不应该注意到任何中断。在本章中，我们将深入研究有关微服务和相关主题的一些基础知识。

在本章中，我们将讨论：

*   单片结构及其缺点
*   微服务及其好处
*   微服务的基本特征
*   微服务组件
*   微服务工具

# 单片结构及其缺点

尽管微服务体系结构如今越来越流行，但大多数公司仍然使用单片体系结构。作为一个整体应用程序，您可以将所有业务模块捆绑到一个单元中，并将它们部署到所有所需的服务器中。如果应用程序中需要任何更改，开发人员必须提供这些更改并重新部署应用程序的更新版本。在单片中，我们遵循服务模块之间的紧密耦合。

虽然单片体系结构有一些优点，但其缺点为替代体系结构设计微服务铺平了道路。这里我们将讨论一下单片架构的缺点：

*   对于每个 bug 修复或代码更改，我们必须在所有服务器上重新部署整个应用程序
*   如果单片应用程序中存在任何常见问题，例如性能问题，它将影响整个应用程序，这可能很难找到并快速修复
*   较大的应用程序在部署期间可能需要较长的启动时间
*   库要求和冲突可能会影响整个应用程序。我们将很难修复支持所有模块的库
*   由于所有模块都在同一个保护伞下，所以对于整体来说，扩展可能很困难
*   当应用程序增长时，业务逻辑和实现的复杂性也将增长，这可能需要更多的时间来开发和维护
*   不频繁、昂贵且大规模部署选项：如果我们有多种类型的业务逻辑和层，并且希望升级一种业务逻辑，那么我们还需要部署所有其他层/服务
*   当一个服务/层需要升级时，紧密耦合的服务会造成困难

# 服务发现

在微服务体系结构中，根据业务需求和服务负载，我们可能必须增加服务实例。在这种情况下，跟踪所有可用的服务实例及其信息（如端口号）将很难管理。通过自动配置服务实例并在需要时查找它们，服务发现将帮助我们管理这些任务。

# 微服务简介

在一个大的应用程序中更改一些东西对开发人员来说是一个持续的痛苦。每次我们在代码中做一点小的更改，我们都可能不得不将整个应用程序部署到服务器中，这是一个耗时而累人的过程，特别是当我们有多个服务时，如记帐、报告、用户管理等。微服务帮助我们摆脱这种痛苦。微服务的主要目标是将应用程序拆分为服务，并独立地将每个服务部署到服务器上。通过这样做，我们在应用程序中提供了松散耦合的进程。此外，可以在云中部署微服务，以避免服务中断问题，并为消费者提供不间断服务。

在 microservices 中，每个模块或业务部分都可以编写为一个单独的服务，以提供连续的交付和集成。这些服务是为满足特定的业务需求而构建的，并且它们可以通过自动化部署基础架构来独立部署。管理这些服务可以分散，也可以用不同的语言编程。

在继续讨论组件之前，我们将简要讨论微服务的基本特征。

# 独立和自治

微服务是单片环境的更好替代品。在微服务中，每个服务都可以随时启动、停止、升级或更换，而不会中断其他服务。所有服务都是独立的，可以自动注册到我们的中央注册中心。

# 弹性和容错

在复杂的应用程序设计中，创建弹性系统对于每个服务都至关重要。大多数云环境都需要一种体系结构设计，其中所有服务都会对意外情况（如停机等）做出响应。这些场景可能接收到坏数据（坏数据），可能无法访问所需的服务，或者可能在并发系统中请求冲突。微服务需要具有故障恢复能力，并且应该能够快速重启。

微服务应防止故障通过系统中的其他依赖服务级联。

# 自动化环境

自动化应该是微服务体系结构设计中的一个重要因素，因为应用程序中将涉及许多服务，因此服务之间的交互将非常复杂。必须实施自动化监控和警报管理系统，以增强微服务设计。所有服务都应该记录它们的数据和度量，并且应该适当地监控这些度量，因为这将改进服务管理。

# 无国籍

微服务是无状态的，这意味着它们不会将数据从一个会话保存到另一个会话。此外，微服务实例不会相互交互。当应用程序中有更多的 microservice 实例可用时，每个实例都不会知道其他实例，无论下一个实例是否处于活动状态。当我们扩展应用程序时，此特性非常有用。

# 微服务的好处

在本节中，我们将讨论在应用程序中开发微服务的好处：

*   业务逻辑可以分组并开发成易于开发和部署的服务，具有多个服务实例
*   微服务通过将应用程序拆分为多个服务，提供易于开发和维护的业务逻辑，特别是在升级特定部分时，可以避免复杂的应用程序
*   服务可以独立部署，而不会中断应用程序；因此，最终用户永远不会感觉到任何服务中断
*   松散耦合的服务将在扩展应用程序方面提供更大的灵活性
*   单独升级服务以满足流行的业务需求非常方便，开发人员可以引入新技术来开发服务
*   借助微服务，连续部署更容易实现；因此，可以对所需的模块进行快速升级
*   扩展这些服务将是非常灵活的，特别是当特定的业务需求需要更多的实例来在高流量的情况下为最终用户提供不间断的服务时
*   组织可以专注于小批量的工作，这些工作可以快速投入生产，特别是在为特定客户测试新功能时

# 微服务组件

为了拥有功能齐全的 microservice 应用程序，必须正确使用以下组件。这些组件帮助我们解决服务之间复杂的业务逻辑分布：

*   配置服务器
*   负载平衡器
*   服务发现
*   断路器
*   边缘服务器

我们将在本节中简要讨论这些组件。

# 配置服务器

配置服务器将帮助我们存储将部署的每个服务的所有可配置参数。如果需要，可以将这些属性保存在存储库中。此外，配置服务器将提供更改应用程序配置的选项，而无需部署代码。一旦配置被更改，它将在运行中自动反映出来，因此我们可以避免重新部署我们的服务。

由于我们的 microservice 应用程序中有许多服务，因此配置服务器将帮助我们避免重新部署服务，并且服务可以从服务器获得相应的配置。这也是持续交付的原则之一：将源代码与配置分离。

# 负载平衡器

负载平衡器通过将负载分配给特定服务，充当扩展应用程序的主干。负载平衡器被认为是微服务体系结构中的主要参与者。与分布在服务器之间的常规负载平衡器不同，这些平衡器管理服务实例并在这些实例之间分配负载。在服务发现组件的帮助下，他们将获得有关可用服务实例的信息并分配负载。

Netflix Ribbon 用作负载平衡器；我们将在本章的*微服务工具*部分对此进行探讨。

# 断路器

由于在我们的体系结构中有许多服务协同工作，因此每个服务可能是相互依赖的。有些情况会导致某些服务失败，并可能导致其他服务随之崩溃。为了避免这种情况，我们的体系结构应该是容错的。使用断路器之类的模式可以减少微服务架构中的故障。

# 边缘服务器

边缘服务器实现了 API 网关模式，其行为类似于 API 与外部世界的隔离墙。在边缘服务器的帮助下，所有公共流量将转发到我们的内部服务。通过这样做，最终用户将不会在未来我们的服务和内部结构发生任何变化的情况下受到影响。Netflix Zuul 用作边缘服务器，我们将在下一节中分享一点关于 Zuul 的信息。

# 微服务工具

Netflix 工程师为微服务开发做出了巨大贡献，并为微服务生态系统引入了各种组件。在这里，我们将讨论更多可能与微服务相关的组件：

*   Netflix Eureka
*   Netflix Zuul
*   Spring 云配置服务器
*   Netflix Ribbon
*   春云网飞
*   Spring 安全 OAuth2
*   Netflix Hystrix 和 Turbine
*   Eclipse 微文件

我们将在接下来的章节中进一步讨论它们。

# Netflix Eureka

Eureka 在微服务中扮演着服务发现服务的角色。它允许微服务在运行时进行自我注册，并在需要时帮助我们定位服务。它用于中间层服务器的负载平衡和故障转移。此外，Eureka 还附带了一个 Java 客户端（Eureka 客户端），使服务交互更加容易。Eureka 服务器通过在中间层服务器中定位服务，充当中间层（服务级别）负载平衡工具。这些中间层（服务级别）负载平衡工具可能不适用于类似 AWS 的云。

虽然 AWS**弹性负载平衡器**（**ELB**）可用于负载平衡服务，但它只支持终端用户 web 服务，如传统负载平衡器，不支持中间层负载平衡。

在 Eureka 服务器中，客户机的实例知道它们必须与哪些服务通信，因为 Eureka 负载平衡器也关注实例级别。Eureka 服务是无状态的，因此它们支持可伸缩性。由于服务器信息缓存在客户端，因此在负载平衡器中断的情况下，负载平衡非常有用。

Euleka 在 Netflix 中用于 memcached 服务、cassandra 部署和其他操作。对于中间层服务，强烈建议使用 Eureka 服务器，因为应该为公众禁用本地服务。

Netflix 开发人员启动了 Eureka 服务器并使其开源。后来，Spring 将其合并到 Spring 云中。在微服务体系结构中，服务应该是细粒度的，以改进应用程序的模块化，用于开发、测试和维护。

# Netflix Zuul

Zuul 充当公众的前门看门人，不允许未经授权的外部请求通过。它还提供了服务器中微服务的入口点。Zuul 使用 Netflix Ribbon 查找可用服务，并将外部请求路由到正确的服务实例。Zuul 支持动态路由、监视和安全性。

Zuul 的不同类型的过滤器，如`PRE`、`ROUTING`、`POST`、`ERROR`，有助于实现以下功能：

*   动态路由
*   洞察和监测
*   认证和安全
*   压力测试
*   多区域弹性
*   静态响应处理

Zuul 有多个组件：

*   `zuul-core`
*   `zuul-simple-webapp`
*   `zuul-netflix`
*   `zuul-netflix-webapp`

# 春云网飞

SpringCloud 提供第三方云技术和 Spring 编程模型之间的交互。Spring Cloud Netflix 提供 Netflix**开源软件**（**OSS**）集成支持，通过自动配置和绑定到 Spring 环境与 Spring Boot 协同工作。通过在 SpringBoot 中添加一些注释，我们可以构建一个大型的分布式应用程序，包括 Netflix 组件。

诸如服务发现、服务创建、外部配置、路由器和过滤器等功能可以通过微服务在 SpringCloudNetfix 中实现。

# Netflix Ribbon

服务消费者使用 Netflix 在运行时查找服务。Ribbon 从 Eureka 服务器获取信息，以定位适当的服务实例。如果 Ribbon 有多个可用实例，它将应用负载平衡机制将请求分散到可用实例上。Ribbon 不作为单独的服务运行，而是作为每个服务使用者中的嵌入式组件运行。拥有客户端负载平衡是使用服务注册表的一大好处，因为平衡器允许客户端选择已注册的服务实例。

Ribbon 提供以下功能：

*   负载平衡规则（多个和可插拔）
*   服务发现集成
*   对失败有弹性
*   对云的支持

Ribbon 有子组件，如`ribbon-core`、`ribbon-eureka`和`ribbon-httpclient`。

Netflix Ribbon acts as a client-side load balancer, and it can be integrated with Spring Cloud.

# Netflix Hystrix

每个分布式环境都容易发生服务故障，这可能经常发生。为了解决这个问题，我们的体系结构应该是容错和延迟的。Hystrix 是一个断路器，可以帮助我们避免此类情况，如服务依赖性故障。Hystrix 防止服务过载，并在发生故障时隔离故障。

有了 Hystrix 支持，我们可以通过在微服务中添加延迟容忍和容错逻辑来控制它们之间的交互。Hystrix 在服务失败的情况下提供了强大的备用选项，从而提高了系统的整体恢复能力。如果没有 Hystrix，如果内部服务失败，它可能会中断 API 并破坏用户体验。

Hystrix 遵循以下几个基本弹性原则：

*   服务依赖性中的故障不应导致最终用户的任何中断
*   API 应该在服务依赖性失败的情况下做出反应，以采取正确的操作

Hystrix 还具有使用以下方法的断路器回退机制：

*   **自定义回退**：客户端库提供回退，或本地数据生成响应
*   **无提示失败**：回退返回 null，这在某些情况下很有用
*   **Fail fast**：用于特定情况，如 HTTP 5XX 响应

# Netflix 涡轮机

Turbine 用于将**服务器发送事件**（**SSE**JSON 数据的所有流聚合为一个流，可用于仪表板目的。Turbine 工具用于 Hystrix 应用程序，该应用程序具有一个实时仪表板，用于聚合来自多台机器的数据。Turbine 可以与支持 JSON 格式的任何数据源一起使用。Turbine 是数据不可知的，能够将 JSON blob 视为键和值对的映射。

Netflix 使用 Turbine 和 Eureka 服务器插件来处理由于各种原因（如自动缩放、不健康等）而加入或离开集群的实例。

# 哈希科领事

Concur 是一个支持微服务的服务发现和配置工具。Consour 于 2014 年由 Hashi Corp 发起，主要专注于跨多个数据中心的分布式服务。此外，Concur 保持数据安全，并与大型基础设施合作。通过使用键和值配置服务，并找到它所需要的服务，Concur 解决了微服务的核心问题。

Concur 具有形成单个 Concur 群集的服务器和客户端。在 Consor 集群中，节点将能够存储和复制数据。在至少一个成员地址的帮助下，会自动发现群集中的其他成员。此外，concur 提供了一个动态的基础架构，因此不需要额外的编码/开发来自动发现服务。

Consul is made for both the DevOps community and application developers to support modern and elastic infrastructures.

# Eclipse 微文件

Eclipse 微文件是由 RedHat、IBM 和其他组织等公司发起的，目的是提供构建微服务的规范。该项目于 2016 年启动，最近他们发布了 1.2 版本的 MicroFile。它主要关注于为微服务架构优化企业 Java。Payara Micro 和 Payara 服务器都与 Eclipse MicroFile 兼容。

EclipseMrobroFile 1.2 版附带了配置 API、运行状况检查、容错、度量和其他支持微服务的必要工具。

# 总结

在本章中，我们简要地讨论了整块石及其缺点。然后我们讨论了微服务及其好处，以及相关的话题。此外，我们还讨论了微服务的基本原则，包括弹性和容错性。

在本章后面的部分中，我们讨论了微服务组件以及与微服务相关的工具，如 Netflix Eureka、Zuul 等。在下一章也是最后一章中，我们将研究票证管理实时场景，以及高级 CRUD 操作，包括身份验证和授权。