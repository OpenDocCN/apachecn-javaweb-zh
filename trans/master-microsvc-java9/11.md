# 将单片应用程序迁移到基于微服务的应用程序

我们已经到了本书的最后一章，我希望您已经喜欢并掌握了完整的堆栈（DB 除外）微服务开发。我已经尝试接触了所有必要的主题，这些主题将为您提供一个基于微服务的生产应用程序的完整视图，并允许您继续进行更多的探索。由于您已经了解了微服务体系结构和设计，因此可以轻松区分单片应用程序和基于微服务的应用程序，并且可以确定将单片应用程序迁移到基于微服务的应用程序需要做哪些工作。

在本章中，我们将讨论如何将单片应用程序重构为基于微服务的应用程序。我假设现有的单片应用程序已经部署并被客户使用。在本章的最后，您将了解可以使用的不同方法和策略，以使单片迁移到微服务更容易。

本章涵盖以下主题：

*   您需要迁移吗？
*   成功迁移的方法和关键

# 您需要迁移吗？

这是应该为您的迁移确定基调的第一个问题。您真的需要将现有应用程序迁移到基于微服务的体系结构吗？它给餐桌带来了什么好处？后果是什么？我们如何支持现有的本地客户？现有客户是否支持并承担迁移到微服务的成本？我需要从头开始写代码吗？如何将数据迁移到新的基于微服务的系统？这次迁移的时间表是什么？现有团队是否足够熟练，能够快速实现这一变化？在这次迁移过程中，我们可以接受新的功能更改吗？我们的流程是否符合迁移要求？诸如此类。我相信你会想到很多类似的问题。我希望，在前面的所有章节中，您可能已经对基于微服务的系统所需要的工作有了很好的了解。

在考虑了所有的利弊之后，您的团队将决定迁移。如果答案是肯定的，本章将帮助您实现迁移。

# 云与内部部署对比云与内部部署

您现有的云解决方案、内部部署解决方案是什么，或者您是否同时提供云和内部部署解决方案，或者您是否希望与内部部署解决方案一起启动云解决方案。您的方法将基于您提供的解决方案类型。

# 纯云解决方案

如果您提供云解决方案，那么您的迁移任务将比其他两个解决方案更容易。话虽如此，但这并不意味着这将是一次轻松愉快的散步。您可以完全控制迁移。您可以不考虑迁移对客户的直接影响。云客户只需使用该解决方案，而不必担心它是如何实现或托管的。我假设没有 API 或 SDK 更改，显然，迁移不应该涉及任何功能更改。只有云上的微服务迁移具有使用平滑增量迁移的优势。这意味着您将首先转换 UI 应用程序，然后是一个 API/服务，然后是下一个，依此类推。请注意，你在控制之中。

# 仅限前提的解决方案

本地解决方案部署在客户基础架构上。最重要的是，您可能有许多在其基础架构上部署了不同版本的客户端。您无法完全控制这些部署。您需要与客户合作，成功迁移需要团队的努力。

此外，在接触客户之前，您应该准备好完整的肉体迁移解决方案。拥有不同版本的产品会让这变得更加困难。我建议只提供最新版本的迁移，在开发迁移时，只允许客户使用安全和中断修复。是的，您不应该提供任何新功能。

# 云和内部部署解决方案

如果您的应用程序同时具有云和本地产品，那么本地解决方案到微服务的迁移可以与云同步，反之亦然。这意味着，如果您花费精力迁移其中一个，您可以在另一个上复制相同的。因此，除了在其他环境中进行复制之外，它还包括前面提到的云或内部部署迁移方面的挑战。此外，有时本地客户可能有自己的定制。迁移时还需要注意它。在这里，您自己的云解决方案应该首先迁移到微服务，以后可以在本地进行复制。

迁移仅提供内部部署的生产/解决方案，但您也需要启动云部署；这是最具挑战性的。您应该按照我的微服务设计迁移现有代码，同时确保它也支持现有的内部部署。有时，它可能是一个遗留技术堆栈，甚至现有代码可能是使用一些自己的专有技术（如协议）编写的。可能是现有的设计不够灵活，无法突破微服务。这种类型的迁移带来了最大的挑战。应该完成内部解决方案到微服务的增量迁移，您可以首先分离 UI 应用程序，并提供与 UI 应用程序交互的外部 API。如果 API 已经到位，或者您的应用程序已经被划分为单独的 UI 应用程序，相信我，这将从迁移中消除大量负担。然后，您可以将重点放在服务器端的 API 上，包括为应用程序开发的 API。您可能会问，为什么我们不能同时迁移所有 UI 应用程序、API 和服务器代码。是的，你可以。但是，进行增量迁移会给您带来保证、信心和快速的失败/学习。毕竟，敏捷开发都是关于增量开发的。

如果您现有的代码不是模块化的，或者包含大量遗留代码，那么我建议您首先重构它并使其模块化。这会使你的任务更容易。话虽如此，它应该一个模块一个模块地完成。在将代码迁移到纯微服务之前，尽可能地分解和重构任何代码。

我们将讨论一些可能帮助您将大型复杂单片应用程序重构为微服务的方法。

# 成功迁移的方法和关键

软件现代化已经做了很多年了。要实现成功的软件现代化，需要做大量的工作。您将发现，了解成功实现软件现代化（迁移）的所有最佳实践和原则非常有用。在本章中，我们将具体讨论微服务体系结构的软件现代化。

# 增量迁移

您应该以增量方式将单片应用程序转换为微服务。您不应该同时开始整个代码的全面迁移。它会影响风险回报率，增加失败的概率。它还增加了过渡时间的概率，从而增加了成本。您可能希望将代码分解为不同的模块，然后开始逐个转换每个模块。很可能您需要从头开始重写一些模块，如果现有代码紧密耦合且过于复杂而无法重构，则应该这样做。但是，从头开始编写完整的解决方案是一个大问题。你应该避免它。它增加了成本、迁移时间和失败概率。

# 过程自动化和工具设置

敏捷方法论与微服务齐头并进。您可以将任何敏捷过程（如 Scrum 和看板）与现代开发过程（如测试驱动开发或同级编程）一起用于增量开发。对于基于微服务的环境，流程自动化是必不可少的。您应该有自动化的 CI/CD 和测试自动化。如果还没有使用 CI/CD 管道完成可交付成果的容器化，那么您应该这样做。它支持新开发的微服务与现有系统或其他新微服务的成功集成。

您可能希望并行设置服务发现、服务网关、配置服务器或任何基于事件的系统，或者在第一次微服务转换开始之前进行设置。

# 试点项目

我在微服务迁移中观察到的另一个问题是使用不同的模块开始开发。理想情况下，一个小团队应该执行试点项目，将任何现有模块转换为微服务。一旦成功，同样的方法可以复制到其他模块。如果您同时开始迁移各种模块，那么您可能会在所有微服务中重复相同的错误。它增加了失败的风险和转换的持续时间。

执行成功迁移的团队提供了成功开发模块及其与现有单片应用程序集成的方法。如果您成功地开发并将每个模块逐一转换为微服务，那么在某个时间点，您将拥有一个基于微服务的应用程序，而不是一个单一的应用程序。

# 独立用户界面应用程序

如果您已经有使用 API 的独立用户界面应用程序，那么您离成功迁移已经有几步之遥了。如果不是这样，那么第一步应该是将用户界面与服务器代码分离。UI 应用程序将使用这些 API。如果现有应用程序没有 UI 应用程序应该使用的 API，那么您应该在现有代码之上编写包装器 API。

请看下图，它反映了 UI 应用程序迁移前的表示层：

![](assets/59d116bf-c7db-4216-9203-33f56b466a98.png)

在 UI 应用程序迁移之前

下图反映了 UI 应用程序迁移后的表示层：

![](assets/56cc418e-1d2e-4987-be74-eb62894213fc.png)

UI 应用程序迁移后

您可以在前面看到，UI 与业务逻辑和 DAO 一起包含在单片应用程序中。迁移后，UI 应用程序与单片应用程序分离，并使用 API 与服务器代码通信。REST 是实现可以在现有代码之上编写的 API 的标准。

# 将模块迁移到微服务

现在，您有了一个服务器端单片应用程序和一个或多个 UI 应用程序。它为您提供了另一个优势，即在使用 API 的同时将模块与现有单片应用程序分离。例如，在分离 UI 应用程序之后，可以将其中一个模块转换为微服务。一旦 UI 应用程序成功测试，与此模块相关的 API 调用可以路由到新转换的模块，而不是现有的单片 API。如下图所示，当调用 API`GET/customer/1`时，web`Gateway`可以将请求路由到`Customer Microservice`而不是`Monolithic`应用程序。

通过比较单片和微服务模块的响应，您还可以在新的基于微服务的 API 上线之前对产品执行测试。一旦我们有了一致匹配的响应，我们就可以确保转换成功完成，并且可以将 API 调用迁移到重构模块 API。如下图所示，部署了一个组件，该组件在调用客户 API 时再次调用新的客户微服务。然后，它比较两个调用的响应并存储结果。可以对这些结果进行分析，并对任何不一致性进行修复。当来自新转换的微服务的响应与现有单片响应匹配时，您可以停止将调用路由到现有单片应用程序，并用新的微服务替换它。

按照这种方法，您可以将模块逐个迁移到微服务，并且在某个时间点，您可以将所有单片模块迁移到微服务。

![](assets/237764f3-242b-43bc-8fb1-33eac8744c1c.png)

API 路由、比较和迁移

# 如何在迁移过程中适应新功能

在迁移期间的理想情况下，应避免使用新功能。只允许进行重要的修复和安全更改。然而，如果迫切需要实现一个新功能，那么它应该在一个单独的微服务中开发，或者以模块化的方式开发到现有的单片代码中，使其与现有代码的分离更加容易。

例如，如果您在`customer`模块中确实需要一个不依赖于其他模块的新功能，您可以简单地创建一个新的 customer microservice，并通过外部世界或其他模块将其用于特定的 API 调用。是否使用 REST 调用或事件进行进程间通信取决于您。

类似地，如果您需要依赖于其他模块的新功能（例如，依赖于预订的新客户功能），并且它没有作为 API 公开给 UI 或服务 API，那么它仍然可以作为单独的微服务开发，如下图所示。`customer`模块调用新开发的微服务，然后调用`booking`模块进行请求处理，并将响应返回给`customer`模块。这里，对于进程间通信，可以使用 REST 或事件。

![](assets/2acbdfb7-53ea-4a58-8739-5c945ff95560.png)

将新模块实现为调用另一个模块的微服务

# 工具书类

有关代码重构和域驱动设计的更多信息，请阅读以下书籍：

*   *重构：Martin Fowler 改进现有代码*的设计
*   Eric J.Evans 的*领域驱动设计*

# 总结

软件现代化是前进的方向，在当前的环境中，由于一切都转移到了云端，资源能力和容量也在增加，基于设计的微服务看起来比其他任何东西都更合适。我们讨论了云和内部部署解决方案的组合，以及将它们转换为微服务的挑战。

我们还讨论了为什么就单片应用程序迁移到微服务而言，增量开发方法是首选的。我们讨论了成功迁移到微服务所需的各种方法和实践。